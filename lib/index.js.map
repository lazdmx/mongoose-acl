{"version":3,"sources":["index.js"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["'use strict'\nimport from 'es6-shim'\nimport assert from 'assert'\nimport mongoose from 'mongoose'\nimport {EventEmitter} from 'events'\n\nconst {Schema: {Types: {Mixed}}, Types: {ObjectId}} = mongoose\n\n//------------------------------------------------------------------------------\nconst AclPath = 'acl'\nconst AclScopeName = 'acl'\n\n// Array#from whould be used when it will be provided by node\nfunction set2array(s){\n  let arr = []\n  for(let i of s.keys()) arr.push(i)\n  return arr\n}\n\n//------------------------------------------------------------------------------\nfunction toSetOfGrantees(v){\n  v = v || new Set()\n  v = v.grantees ? v.grantees : v\n\n  if(Array.isArray(v)){\n    return new Set(v)\n  }\n\n  if(v instanceof Set){\n    return v\n  }\n\n  return new Set().add(v)\n}\n\n\n//------------------------------------------------------------------------------\nfunction isMatchingGrant(scope, grantees){\n  grantees = toSetOfGrantees(grantees)\n  return function(v){\n    return grantees.has(v.grantee) && v.scope == scope\n  }\n}\n\n//------------------------------------------------------------------------------\nclass AclWriter extends EventEmitter{\n\n  //-------------------------\n  constructor(doc, tag, opts){\n    this.doc = doc\n    this.tag = tag\n    this.opts = opts\n  }\n\n  //-------------------------\n  scope(scopeName){\n    assert.ok(scopeName, 'Scope must be defined')\n    if(!this.opts.scopes.find(v => v.name == scopeName)){\n      throw new Error(`Invalid scope <${scopeName}> provided`)\n    }\n    this.currentScope = scopeName\n    return this\n  }\n\n  //-------------------------\n  scopes(){\n    return this.opts.scopes.map(v => v.name)\n  }\n\n  //-------------------------\n  tags(){\n    return this.doc[this.opts.path].tags.map(v => v.name)\n  }\n  //-------------------------\n  access(grantees){\n    assert.ok(this.currentScope, 'Scope is not selected')\n    grantees = toSetOfGrantees(grantees)\n\n    return this.tag.grants\n      .filter(isMatchingGrant(this.currentScope, grantees))\n      .reduce((o, v) => o < v.permission ? v.permission : o, this.opts.lowestAccess)\n  }\n\n  //-------------------------\n  end(){\n    return this\n  }\n\n    //-------------------------\n  grantAccess(grantees, permission){\n    if(permission == null){\n      permission = grantees\n      grantees = this.doc[this.opts.path].grants\n        .filter(v => v.scope === this.currentScope)\n        .map(v => v.grantee)\n    }\n\n    assert.ok(grantees, 'Grantees must be defined')\n    assert.ok(permission >= this.opts.lowestAccess, 'Invalid permission level')\n\n    grantees = toSetOfGrantees(grantees)\n    for(let grantee of grantees){\n      let grant = this.tag.grants.find(isMatchingGrant(this.currentScope, grantee))\n\n      if(!grant){\n        grant = {\n          id: new ObjectId(),\n          grantee: grantee,\n          permission: permission,\n          scope: this.currentScope\n        }\n\n        this.tag.grants.push(grant)\n        this.markModified()\n      }\n\n      if(grant.permission != permission){\n        grant.permission = permission\n        this.markModified()\n      }\n    }\n    return this\n  }\n\n  //-------------------------\n  denyAccess(grantees){\n    return this.grantAccess(grantees, this.opts.lowestAccess)\n  }\n\n  //-------------------------\n  apply(){\n    if(!this.doc.isModified(this.opts.path)){\n      return this.doc\n    }\n\n    let acl = this.doc[this.opts.path]\n\n    let map = new Map()\n    for(let tag of acl.tags){\n      for(let grant of tag.grants){\n        let key = `${grant.scope}:${grant.grantee}`\n        map.set(key, grant.permission)\n      }\n    }\n\n    acl.grants = []\n    for(let [k, p] of map.entries()){\n      let [scope, grantee] = k.split(':')\n      acl.grants.push({\n        id: new ObjectId(),\n        scope: scope,\n        grantee: grantee,\n        permission: p\n      })\n    }\n\n    if(map.size) this.markModified()\n    return this.doc\n  }\n\n  //-------------------------\n  reject(){\n    let acl = this.doc[this.opts.path]\n    acl.tags = acl.tags.filter(v => v !== this.tag)\n    this.markModified()\n    return this\n  }\n\n  //-------------------------\n  markModified(){\n    this.doc.markModified(this.opts.path)\n    this.emit('modify')\n  }\n}\n\n//------------------------------------------------------------------------------\nfunction getAcl(opts, tagName){\n  'use strict'\n  assert.ok(this.isSelected(opts.path), 'Acl must be selected')\n\n  const acl = !this[opts.path]\n    ? this[opts.path] = {tags: [], grants: []}\n    : this[opts.path]\n\n  if(tagName){\n    if(!acl.tags.find(v => v.name == tagName)){\n      acl.tags.push({name: tagName, grants: []})\n    }\n  }\n\n  let tag = tagName\n    ? acl.tags.find(v => v.name == tagName)\n    : acl\n\n  return new AclWriter(this, tag, opts)\n}\n\n\n//------------------------------------------------------------------------------\nfunction findAccessibleBy(opts, grantees, permission, scope, selectAclScope = true){\n  assert.ok(permission >= opts.lowestAccess, 'Invalid permission level')\n  assert.ok(scope, 'Scope must be defined')\n\n  grantees = toSetOfGrantees(grantees)\n\n  let q = this.where(`${opts.path}.grants`).elemMatch({\n    scope      : scope,\n    grantee    : {$in: set2array(grantees)},\n    permission : {$gte: permission}\n  })\n\n  return selectAclScope\n    ? q.select(this.select('acl'))\n    : q\n}\n\n\n//------------------------------------------------------------------------------\nfunction explainAcl(opts, grantees){\n  grantees = toSetOfGrantees(grantees)\n\n  let acl = this.getAcl()\n  return acl.scopes().reduce(function(o, scope){\n    o[scope] = acl.scope(scope).access(grantees)\n    return o\n  }, {})\n}\n\n//------------------------------------------------------------------------------\nfunction selectList(opts, ...scopes){\n  'use strict'\n  scopes = new Set(scopes)\n  return set2array(\n    opts.scopes\n      .filter(v => scopes.has(v.name))\n      .reduce((o, v) => v.paths.reduce((o, v) => o.add(v), o), new Set())\n      .add(opts.path)\n  )\n}\n\n//------------------------------------------------------------------------------\nexport default function plugin(sch, opts){\n  opts.path = opts.path || AclPath\n  opts.scopes = opts.scopes.filter(v => v.name != AclScopeName)\n  opts.scopes.push({name: AclScopeName, paths: [AclPath]})\n  opts.lowestAccess = opts.lowestAccess != null\n    ? opts.lowestAccess\n    : 0\n\n  // В качестве временного решения запрещаем размещять ACL на вложенных полях\n  // модели.\n  assert.ok(opts.path.search(/\\./) == -1)\n\n  sch.path(opts.path, Mixed)\n  sch.index({\n    [`${opts.path}.grants.scope`]: 1,\n    [`${opts.path}.grants.grantee`]: 1,\n    [`${opts.path}.grants.permission`]: 1\n  })\n\n  sch.statics.__plugin_acl_enabled__ = true\n  sch.statics.aclPath = opts.path\n\n  sch.statics.select = function (...scopes){\n    return this.selectList(...scopes).join(' ')\n  }\n\n  sch.statics.selectList = function (...scopes){\n    return selectList.apply(this, [opts, ...scopes])\n  }\n\n  sch.statics.findAccessibleBy = function(grantees, permission, scope, selectAclScope){\n    return findAccessibleBy.call(this, opts, grantees, permission, scope, selectAclScope)\n  }\n\n  sch.methods.explainAcl = function(grantees){\n    return explainAcl.call(this, opts, grantees)\n  }\n\n  sch.methods.getAcl = function (tagName){\n    return getAcl.call(this, opts, tagName)\n  }\n}\n"],"sourceRoot":"/source/"}